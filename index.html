<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PilexSwap</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0a0a0a;
      color: #ccfffd;
      text-align: center;
      padding: 2rem;
    }

    .swap-box {
      background: rgba(255,255,255,0.05);
      padding: 2rem;
      border-radius: 10px;
      max-width: 400px;
      margin: auto;
    }

    input, select, button {
      width: 100%;
      margin-top: 1rem;
      padding: 0.7rem;
      border: none;
      border-radius: 6px;
    }

    button {
      background-color: #00cc99;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>PilexSwap (Sepolia)</h1>
  <div class="swap-box">
    <input type="number" id="amountFrom" placeholder="Amount ZUSDT" />
    <button onclick="swapToken()">Swap to ZCT</button>
    <button onclick="connectWallet()">ðŸ”Œ Connect Wallet</button>
  </div>

  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
  <script>
    const swapContractAddress = "0x32A7Acf247F49aAf49A69Fd812dEb3F4fCEF650B";
    const zusdtAddress = "0xAf8f71a176C3aDE603965E06Ce7100117411d919";

    const swapContractABI = [
      {
        "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }],
        "name": "swapZUSDTtoZCT",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    const zusdtABI = [
      {
        "constant": false,
        "inputs": [
          { "name": "_spender", "type": "address" },
          { "name": "_value", "type": "uint256" }
        ],
        "name": "approve",
        "outputs": [{ "name": "", "type": "bool" }],
        "type": "function"
      }
    ];

    let signer;

    async function connectWallet() {
      if (typeof window.ethereum === 'undefined') {
        alert("Install MetaMask dulu!");
        return;
      }

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const { chainId } = await provider.getNetwork();

      if (chainId !== 11155111) {
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0xaa36a7' }]
          });
        } catch (err) {
          alert("Switch ke Sepolia gagal: " + err.message);
          return;
        }
      }

      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      const address = await signer.getAddress();
      alert("Wallet terhubung: " + address);
    }

    async function approveZUSDT(amount) {
      const contract = new ethers.Contract(zusdtAddress, zusdtABI, signer);
      const tx = await contract.approve(swapContractAddress, amount);
      await tx.wait();
    }

    async function swapToken() {
      const amount = document.getElementById("amountFrom").value;
      if (!amount || isNaN(amount) || Number(amount) <= 0) {
        alert("Masukkan jumlah yang valid.");
        return;
      }

      try {
        const parsed = ethers.utils.parseUnits(amount, 18);
        await connectWallet();
        await approveZUSDT(parsed);

        const contract = new ethers.Contract(swapContractAddress, swapContractABI, signer);
        const tx = await contract.swapZUSDTtoZCT(parsed);
        await tx.wait();

        alert("Swap berhasil!");
      } catch (err) {
        console.error(err);
        alert("Swap gagal: " + err.message);
      }
    }
  </script>
</body>
</html>
