<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PilexSwap</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="logo">PilexSwap</div>
    <nav>
      <a href="index.html">Trade</a>
      <a href="pools.html">Pools</a>
      <a href="faucet.html">Faucet</a>
      <a href="nfts.html">NFTs</a>
      <a href="bridge.html">Bridge</a>
    </nav>
    <button class="wallet-btn" id="connectBtn">Connect to a wallet</button>
  </header>

  <main>
    <section class="swap-box">
      <div class="input-group">
        <label>From</label>
        <div class="input-row">
          <input type="number" placeholder="0.0" id="amountFrom" />
          <select id="fromToken">
            <option value="ZUSDT">ZUSDT</option>
          </select>
        </div>
      </div>

      <div class="arrow">↓</div>

      <div class="input-group">
        <label>To</label>
        <div class="input-row">
          <input type="number" placeholder="0.0" disabled />
          <select id="toToken">
            <option value="ZCT">ZCT</option>
          </select>
        </div>
      </div>

      <button class="connect-wallet">Swap</button>
    </section>
  </main>

  <footer>
    <p>© 2025 ZenSwap. All rights reserved.</p>
  </footer>

  <!-- Script imports -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.8/dist/index.js"></script>
  <script>
    const swapContractAddress = "0x32A7Acf247F49aAf49A69Fd812dEb3F4fCEF650B";
    const zusdtAddress = "0xAf8f71a176C3aDE603965E06Ce7100117411d919";
    const swapContractABI = [
      {
        inputs: [{ internalType: "uint256", name: "amount", type: "uint256" }],
        name: "swapZUSDTtoZCT",
        outputs: [],
        stateMutability: "nonpayable",
        type: "function"
      }
    ];

    let web3Modal, provider, signer, userAddress;

    async function switchToSepolia() {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0xaa36a7' }]
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: '0xaa36a7',
                chainName: 'Sepolia',
                rpcUrls: ['https://rpc.sepolia.org'],
                nativeCurrency: {
                  name: 'Sepolia ETH',
                  symbol: 'ETH',
                  decimals: 18
                },
                blockExplorerUrls: ['https://sepolia.etherscan.io']
              }]
            });
          } catch (addError) {
            alert("Gagal menambahkan jaringan Sepolia.");
          }
        } else {
          alert("Switch jaringan dibatalkan atau gagal.");
        }
      }
    }

    async function init() {
      const providerOptions = {
        walletconnect: {
          package: window.WalletConnectProvider.default,
          options: {
            infuraId: "1c84a99f763144348d5fa28316d42b49"
          }
        },
        injected: {
          display: {
            name: "MetaMask / OKX",
            description: "Connect with MetaMask or OKX"
          }
        }
      };

      web3Modal = new window.Web3Modal.default({
        cacheProvider: false,
        providerOptions
      });
    }

    async function connectWallet() {
      try {
        const instance = await web3Modal.connect();
        provider = new ethers.providers.Web3Provider(instance);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        const { chainId } = await provider.getNetwork();
        if (chainId !== 11155111) {
          await switchToSepolia();
        }

        document.querySelectorAll('.wallet-btn, .connect-wallet').forEach(btn => {
          btn.textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
          btn.disabled = true;
        });

        return true;
      } catch (err) {
        console.error("Connect wallet failed:", err);
        alert("Gagal koneksi wallet: " + err.message);
        return false;
      }
    }

    async function swapToken() {
      const amount = document.getElementById("amountFrom").value;
      if (!amount || isNaN(amount) || Number(amount) <= 0) {
        alert("Masukkan jumlah yang valid.");
        return;
      }

      if (!signer) {
        const connected = await connectWallet();
        if (!connected) return;
      }

      const ERC20_ABI = [
        "function approve(address spender, uint256 amount) public returns (bool)"
      ];

      try {
        const zusdt = new ethers.Contract(zusdtAddress, ERC20_ABI, signer);
        const parsedAmount = ethers.utils.parseUnits(amount, 18);

        const approvalTx = await zusdt.approve(swapContractAddress, parsedAmount);
        await approvalTx.wait();

        const contract = new ethers.Contract(swapContractAddress, swapContractABI, signer);
        const tx = await contract.swapZUSDTtoZCT(parsedAmount);
        await tx.wait();

        alert("Swap berhasil!");
      } catch (err) {
        alert("Swap gagal: " + err.message);
      }
    }

    window.addEventListener('load', async () => {
      await init();
      document.getElementById('connectBtn').addEventListener('click', connectWallet);
      document.querySelector('.connect-wallet').addEventListener('click', swapToken);
    });
  </script>
</body>
</html>
